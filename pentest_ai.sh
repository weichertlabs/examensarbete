#!/bin/bash

# === InstÃ¤llningar ===
TARGET="http://localhost:3000"
REPORT_NAME="pentest_report_$(date +%Y-%m-%d_%H-%M-%S).md"
MODEL="llama3"
OLLAMA_IP=$(ip route | grep default | awk '{print $3}')
OLLAMA_PORT=11434
EXCLUDE_LENGTH=80117
WORDLIST="/usr/share/dirb/wordlists/common.txt"

echo "[*] Skapar rapport: $REPORT_NAME"
echo "# ðŸ›¡ï¸ Pentest-rapport â€“ $(date)" > "$REPORT_NAME"
echo "" >> "$REPORT_NAME"

# === Nikto ===
echo "[*] KÃ¶r Nikto..."
NIKTO_OUT=$(mktemp)
nikto -h "$TARGET" > "$NIKTO_OUT"

{
  echo "## ðŸ” Nikto Output"
  echo '```'
  cat "$NIKTO_OUT"
  echo '```'
  echo ""
  echo "---"
  echo ""
} >> "$REPORT_NAME"

# === WhatWeb ===
echo "[*] KÃ¶r WhatWeb..."
WHATWEB_OUT=$(mktemp)
whatweb "$TARGET" > "$WHATWEB_OUT"

{
  echo "## ðŸŒ WhatWeb Output"
  echo '```'
  cat "$WHATWEB_OUT"
  echo '```'
  echo ""
  echo "---"
  echo ""
} >> "$REPORT_NAME"

# === Gobuster ===
echo "[*] KÃ¶r Gobuster..."
GOBUSTER_OUT=$(mktemp)
gobuster dir -u "$TARGET" -w "$WORDLIST" --exclude-length $EXCLUDE_LENGTH -q > "$GOBUSTER_OUT"

{
  echo "## ðŸ“‚ Gobuster Output"
  echo '```'
  cat "$GOBUSTER_OUT"
  echo '```'
  echo ""
  echo "---"
  echo ""
} >> "$REPORT_NAME"

# === AI-analys ===
echo "[*] Skickar rapport till AI ($MODEL via Ollama)..."

REPORT_CONTENT=$(<"$REPORT_NAME")
PROMPT="Du agerar som en erfaren penetrationstestare med fokus pÃ¥ webbapplikationer. Syftet Ã¤r att tolka teknisk output och fÃ¶reslÃ¥ relevanta nÃ¤sta steg.

Analysera rapporten enligt fÃ¶ljande rubriker:

1. ðŸ” Identifierade sÃ¥rbarheter (per verktyg)
2. ðŸ§ª FÃ¶rslag pÃ¥ vidare tester
3. ðŸ›¡ï¸ Rekommenderade Ã¥tgÃ¤rder
4. ðŸ“Š Allvarlighetsgrad (om mÃ¶jligt)
5. âœ… Sammanfattning (punktlista)

Om mÃ¶jligt, identifiera och kommentera ovanliga headers, saknade sÃ¤kerhetsinstÃ¤llningar eller tecken pÃ¥ dÃ¥lig konfiguration. 
Ge gÃ¤rna exempel pÃ¥ varfÃ¶r dessa fynd kan vara en sÃ¤kerhetsrisk och koppla gÃ¤rna till attacker, vanliga misstag eller OWASP-toppar.

Rapport:
Texten mellan \`\`\` (trippel-backticks) Ã¤r rÃ¥data som ska analyseras.

\`\`\`
$REPORT_CONTENT
\`\`\`
Besvara endast baserat pÃ¥ innehÃ¥llet i rapporten. Om viss information saknas, skriv \"Ej tillrÃ¤cklig data\"."

JSON_PAYLOAD=$(jq -n --arg model "$MODEL" --arg prompt "$PROMPT" '{model: $model, prompt: $prompt, stream: false}')
RESPONSE=$(curl -s "http://$OLLAMA_IP:$OLLAMA_PORT/api/generate" -H "Content-Type: application/json" -d "$JSON_PAYLOAD")
SUMMARY=$(echo "$RESPONSE" | jq -r '.response')

if [[ "$SUMMARY" == "null" || -z "$SUMMARY" ]]; then
  echo "[!] Ingen AI-respons. Fullt svar:"
  echo "$RESPONSE"
  exit 1
fi

{
  echo "## ðŸ¤– AI Summary & Recommendations"
  echo '```'
  echo "$SUMMARY"
  echo '```'
  echo ""
} >> "$REPORT_NAME"

echo "[âœ”] FÃ¤rdig! Rapport sparad som $REPORT_NAME"

#!/bin/bash

# === Inställningar ===
TARGET="http://localhost:3000"
REPORT_NAME="pentest_report_$(date +%Y-%m-%d_%H-%M-%S).md"
MODEL="llama3"
OLLAMA_IP=$(ip route | grep default | awk '{print $3}')
OLLAMA_PORT=11434
EXCLUDE_LENGTH=80117
WORDLIST="/usr/share/dirb/wordlists/common.txt"

echo "[*] Skapar rapport: $REPORT_NAME"
echo "# 🛡️ Pentest-rapport – $(date)" > "$REPORT_NAME"
echo "" >> "$REPORT_NAME"

# === Nikto ===
echo "[*] Kör Nikto..."
NIKTO_OUT=$(mktemp)
nikto -h "$TARGET" > "$NIKTO_OUT"

{
  echo "## 🔍 Nikto Output"
  echo '```'
  cat "$NIKTO_OUT"
  echo '```'
  echo ""
  echo "---"
  echo ""
} >> "$REPORT_NAME"

# === WhatWeb ===
echo "[*] Kör WhatWeb..."
WHATWEB_OUT=$(mktemp)
whatweb "$TARGET" > "$WHATWEB_OUT"

{
  echo "## 🌐 WhatWeb Output"
  echo '```'
  cat "$WHATWEB_OUT"
  echo '```'
  echo ""
  echo "---"
  echo ""
} >> "$REPORT_NAME"

# === Gobuster ===
echo "[*] Kör Gobuster..."
GOBUSTER_OUT=$(mktemp)
gobuster dir -u "$TARGET" -w "$WORDLIST" --exclude-length $EXCLUDE_LENGTH -q > "$GOBUSTER_OUT"

{
  echo "## 📂 Gobuster Output"
  echo '```'
  cat "$GOBUSTER_OUT"
  echo '```'
  echo ""
  echo "---"
  echo ""
} >> "$REPORT_NAME"

# === AI-analys ===
echo "[*] Skickar rapport till AI ($MODEL via Ollama)..."

REPORT_CONTENT=$(<"$REPORT_NAME")
PROMPT="Du agerar som en erfaren penetrationstestare med fokus på webbapplikationer. Syftet är att tolka teknisk output och föreslå relevanta nästa steg.

Analysera rapporten enligt följande rubriker:

1. 🔍 Identifierade sårbarheter (per verktyg)
2. 🧪 Förslag på vidare tester
3. 🛡️ Rekommenderade åtgärder
4. 📊 Allvarlighetsgrad (om möjligt)
5. ✅ Sammanfattning (punktlista)

Om möjligt, identifiera och kommentera ovanliga headers, saknade säkerhetsinställningar eller tecken på dålig konfiguration. 
Ge gärna exempel på varför dessa fynd kan vara en säkerhetsrisk och koppla gärna till attacker, vanliga misstag eller OWASP-toppar.

Rapport:
Texten mellan \`\`\` (trippel-backticks) är rådata som ska analyseras.

\`\`\`
$REPORT_CONTENT
\`\`\`
Besvara endast baserat på innehållet i rapporten. Om viss information saknas, skriv \"Ej tillräcklig data\"."

JSON_PAYLOAD=$(jq -n --arg model "$MODEL" --arg prompt "$PROMPT" '{model: $model, prompt: $prompt, stream: false}')
RESPONSE=$(curl -s "http://$OLLAMA_IP:$OLLAMA_PORT/api/generate" -H "Content-Type: application/json" -d "$JSON_PAYLOAD")
SUMMARY=$(echo "$RESPONSE" | jq -r '.response')

if [[ "$SUMMARY" == "null" || -z "$SUMMARY" ]]; then
  echo "[!] Ingen AI-respons. Fullt svar:"
  echo "$RESPONSE"
  exit 1
fi

{
  echo "## 🤖 AI Summary & Recommendations"
  echo '```'
  echo "$SUMMARY"
  echo '```'
  echo ""
} >> "$REPORT_NAME"

echo "[✔] Färdig! Rapport sparad som $REPORT_NAME"
